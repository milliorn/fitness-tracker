name: ESLint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths-ignore:
      - "**/*.md"
      - ".github/ISSUE_TEMPLATE/**"

permissions:
  contents: read
  security-events: write

concurrency:
  group: lint-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Run ESLint
    runs-on: ubuntu-latest
    env:
      CI: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20" # or node-version-file: .nvmrc
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            **/package-lock.json          # if you have workspaces

      - name: Install dependencies
        run: npm ci --no-audit --no-fund --prefer-offline

      # If you keep the formatter as a standalone install, this will still be sped up by the npm cache above.
      # (Recommended: add @microsoft/eslint-formatter-sarif to devDependencies and delete this step.)
      - name: Install ESLint SARIF formatter
        run: npm install --no-save @microsoft/eslint-formatter-sarif

      # Restore eslint cache
      - name: Restore ESLint cache
        uses: actions/cache@v4
        with:
          path: .eslintcache
          key: eslint-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('.eslintrc*', 'eslint.config.*', 'tsconfig.json') }}
          restore-keys: |
            eslint-${{ runner.os }}-

      - name: Run ESLint (SARIF)
        run: |
          npx eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --cache --cache-location .eslintcache \
            --format node_modules/@microsoft/eslint-formatter-sarif/sarif.js \
            --output-file eslint-results.sarif
        continue-on-error: true

      - name: Upload ESLint results
        if: github.event_name == 'push' # only upload on push, not PRs from forks
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: eslint-results.sarif
